# 股票策略回测系统 - 运行流程说明

## 系统架构

```
┌─────────────────┐         HTTP请求         ┌─────────────────┐
│   Vue前端应用   │ ───────────────────────> │  Flask后端API   │
│  (localhost:3000)│ <─────────────────────── │ (localhost:8080)│
└─────────────────┘         JSON响应          └─────────────────┘
                                                      │
                                                      │ 读取文件
                                                      ▼
                                            ┌─────────────────┐
                                            │   CSV数据文件   │
                                            │  stock/年份/    │
                                            │  *.SZ.csv       │
                                            └─────────────────┘
```

## 完整运行流程

### 1. 系统启动阶段

#### 1.1 启动后端服务
```bash
cd /Users/zhushilin/Desktop/股票回测
python app.py
```
**后端流程：**
- Flask应用启动，监听 `http://localhost:8080`
- 准备API路由：
  - `GET /api/stock/<stock_code>` - 获取股票数据
  - `GET /api/years` - 获取可用年份列表
  - `GET /api/stocks/<year>` - 获取指定年份的股票列表

#### 1.2 启动前端服务
```bash
cd vue
npm install  # 首次运行需要安装依赖
npm run dev
```
**前端流程：**
- Vite开发服务器启动，监听 `http://localhost:3000`
- 配置API代理：将 `/api/*` 请求转发到 `http://localhost:8080`
- 加载Vue应用

### 2. 页面加载阶段

#### 2.1 浏览器访问
用户访问 `http://localhost:3000`

#### 2.2 Vue应用初始化
```javascript
onMounted(async () => {
  await initChart()      // 初始化ECharts图表实例
  await loadStockData()   // 加载默认股票数据（000001.SZ）
})
```

**详细步骤：**

1. **初始化图表容器**
   - 等待DOM渲染完成（`nextTick`）
   - 查找图表DOM元素（`chartRef`）
   - 创建ECharts实例，使用深色主题
   - 设置窗口resize监听器

2. **加载默认数据**
   - 股票代码：`000001.SZ`
   - 周期：`minute`（分钟级）

### 3. 数据查询流程

#### 3.1 用户操作触发
用户可以通过以下方式触发数据查询：
- **输入股票代码**：在输入框输入代码，按回车或点击"查询"按钮
- **切换周期**：点击"分钟"、"日线"、"周线"、"月线"按钮

#### 3.2 前端请求发送
```javascript
loadStockData() {
  1. 验证股票代码是否为空
  2. 设置 loading = true（显示"加载中..."）
  3. 确保图表已初始化
  4. 发送HTTP GET请求：
     GET /api/stock/000001.SZ?period=minute
}
```

**请求路径：**
```
浏览器 → Vite代理 → Flask后端
http://localhost:3000/api/stock/000001.SZ?period=minute
         ↓ (代理转发)
http://localhost:8080/api/stock/000001.SZ?period=minute
```

#### 3.3 后端处理请求

**Flask路由处理：**
```python
@app.route('/api/stock/<stock_code>')
def get_stock_data(stock_code):
```

**处理步骤：**

1. **解析参数**
   - `stock_code`: 从URL路径获取（如：`000001.SZ`）
   - `period`: 从查询参数获取（如：`minute`, `day`, `week`, `month`）
   - `year`: 可选，从查询参数获取

2. **查找数据文件**
   ```python
   find_stock_file(stock_code, year)
   ```
   - 标准化股票代码格式（添加.SZ或.SH后缀）
   - 遍历年份目录（默认从最新年份开始）
   - 查找匹配的CSV文件：`stock/2025/000001.SZ.csv`
   - 返回文件路径和年份

3. **读取和处理数据**
   ```python
   df = pd.read_csv(file_path)
   df['trade_time'] = pd.to_datetime(df['trade_time'])
   df = df.sort_values('trade_time')
   ```

4. **数据聚合**（根据周期）
   ```python
   aggregate_data(df, period)
   ```
   - **minute**: 直接返回原始分钟数据
   - **day**: 按日聚合（开盘、最高、最低、收盘、成交量、成交额）
   - **week**: 按周聚合
   - **month**: 按月聚合

5. **格式化响应**
   ```python
   {
     'success': True,
     'stock_code': '000001.SZ',
     'year': '2025',
     'period': 'minute',
     'data': [...],  # 数据数组
     'count': 13432  # 数据条数
   }
   ```

#### 3.4 前端接收响应

**成功响应处理：**
```javascript
if (response.data.success) {
  1. 更新股票信息（代码、年份、数据量）
  2. 等待DOM更新（nextTick）
  3. 调用 renderChart(response.data.data)
  4. 设置 loading = false
}
```

**错误处理：**
```javascript
catch (err) {
  1. 显示错误信息
  2. 设置 loading = false
  3. 在控制台输出详细错误
}
```

### 4. 图表渲染流程

#### 4.1 数据转换
```javascript
renderChart(data) {
  // 1. 提取时间轴
  dates = data.map(item => item.trade_time)
  
  // 2. 构建K线数据 [开盘, 收盘, 最低, 最高]
  klineData = data.map(item => [
    parseFloat(item.open),
    parseFloat(item.close),
    parseFloat(item.low),
    parseFloat(item.high)
  ])
  
  // 3. 提取成交量
  volumes = data.map(item => parseFloat(item.vol))
  
  // 4. 计算移动平均线
  ma5 = calculateMA(5, data)   // MA5
  ma20 = calculateMA(20, data)  // MA20
}
```

#### 4.2 ECharts配置
创建包含以下元素的图表配置：
- **K线图**（主图）：蜡烛图，红色上涨，绿色下跌
- **MA5线**：5日移动平均线（橙色）
- **MA20线**：20日移动平均线（蓝色）
- **成交量**（副图）：柱状图，颜色随涨跌变化
- **数据缩放**：支持鼠标滚轮和滑块缩放
- **工具提示**：鼠标悬停显示详细信息

#### 4.3 渲染图表
```javascript
chartInstance.setOption(option)
loading.value = false  // 隐藏"加载中..."
```

## 数据流转示例

### 示例：查询000001.SZ的日线数据

```
1. 用户操作
   └─> 点击"日线"按钮

2. 前端处理
   └─> selectPeriod('day')
       └─> loadStockData()
           └─> GET /api/stock/000001.SZ?period=day

3. Vite代理转发
   └─> http://localhost:8080/api/stock/000001.SZ?period=day

4. Flask后端处理
   └─> 查找文件: stock/2025/000001.SZ.csv
   └─> 读取CSV: 13432行分钟数据
   └─> 聚合为日线: 约200行日线数据
   └─> 返回JSON响应

5. 前端接收
   └─> 解析JSON数据
   └─> 转换为图表格式
   └─> 渲染ECharts图表
   └─> 显示日线K线图
```

## 关键文件说明

### 前端文件
- **`src/App.vue`**: 主组件，包含所有业务逻辑
- **`src/main.js`**: Vue应用入口
- **`vite.config.js`**: Vite配置，包含API代理设置

### 后端文件
- **`app.py`**: Flask应用，提供API接口
- **`stock/年份/*.csv`**: 股票数据文件

### 数据文件格式
```csv
trade_time,open,high,low,close,vol,amount
2025-01-02 09:31:00,11.73,11.77,11.72,11.76,3810500.0,44745304.0
2025-01-02 09:32:00,11.74,11.75,11.74,11.74,1167400.0,13717510.0
...
```

## 常见问题排查

### 1. 一直显示"加载中..."
- **检查后端服务**：确保Flask在8080端口运行
- **检查浏览器控制台**：查看是否有错误信息
- **检查网络请求**：在Network标签查看API请求状态

### 2. 找不到股票数据
- **检查文件路径**：确认 `stock/年份/股票代码.csv` 文件存在
- **检查股票代码格式**：应为 `000001.SZ` 或 `000001.SH`

### 3. 图表不显示
- **检查数据格式**：确保CSV文件包含必需的7列
- **检查浏览器控制台**：查看是否有JavaScript错误

## 性能优化说明

1. **数据聚合在后端完成**：减少前端计算负担
2. **按需加载**：只在切换周期时重新请求数据
3. **图表动画关闭**：大数据量时提升渲染性能
4. **数据缩放**：默认显示最近20%的数据，可手动缩放查看历史
